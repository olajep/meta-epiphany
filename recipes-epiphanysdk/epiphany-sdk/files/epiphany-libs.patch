From 70adf1f7b01fdd29d95aa19a662d7994ac122ec4 Mon Sep 17 00:00:00 2001
From: Peter Saunderson <peteasa@gmail.com>
Date: Sun, 19 Jul 2015 08:17:15 +0100
Subject: [PATCH 1/1] epiphany-libs.patch

---
 Makefile                         | 34 ++++++++++++++++++++++++++++++++++
 build_tools/make_common.rules    | 27 ++++++++++++++++++++-------
 build_tools/make_sharedlib.rules |  7 +++++--
 src/e-lib/Makefile               | 10 +++++++++-
 src/e-xml/Makefile               |  7 +++++++
 5 files changed, 75 insertions(+), 10 deletions(-)
 create mode 100644 Makefile

diff --git a/Makefile b/Makefile
new file mode 100644
index 0000000..4210ef3
--- /dev/null
+++ b/Makefile
@@ -0,0 +1,34 @@
+
+DIRS =		src/e-xml	\
+		src/e-server	\
+		src/e-loader	\
+		src/e-memman \
+		src/e-hal	\
+		src/e-utils/e-trace \
+		src/e-utils/e-trace-server \
+		src/e-utils/e-trace-dump \
+		src/e-utils/e-clear-shmtable \
+		src/e-utils/e-reset	\
+		src/e-utils/e-loader	\
+		src/e-utils/e-read	\
+		src/e-utils/e-write	\
+		src/e-utils/e-hw-rev	\
+		src/e-lib
+
+
+.PHONY: all $(DIRS)
+.PHONY: clean $(DIRS)
+.PHONY: install $(DIRS)
+
+all: $(DIRS)
+
+clean: $(DIRS)
+
+install: $(DIRS)
+
+$(DIRS):
+	@echo "**************************************************"
+	@echo Building target: $@
+	@echo Goals: $(MAKECMDGOALS)
+	@echo "**************************************************"
+	$(MAKE) -C $@ $(MAKECMDGOALS)
diff --git a/build_tools/make_common.rules b/build_tools/make_common.rules
index f39be47..82980af 100644
--- a/build_tools/make_common.rules
+++ b/build_tools/make_common.rules
@@ -1,5 +1,5 @@
-CXXFLAGS    	= -Wall -Wextra
-CFLAGS          = -Wall -Wextra
+#CXXFLAGS    	= -Wall -Wextra
+#CFLAGS          = -Wall -Wextra
 RELEASEFLAGS  	= -DNDEBUG -O3
 DEBUGFLAGS  	= -O0 -g
 RELEASEDIR  	= Release
@@ -7,6 +7,18 @@ DEBUGDIR   		= Debug
 DEPDIR 			= .deps
 df 				= $(basename $(DEPDIR)/$@)
 
+##
+## Rules for cross compiling for epiphany-elf do not need these
+##
+##ifneq (,$(findstring arm-poky-linux-gnueabi,$(CROSS_COMPILE)))
+#CXXFLAGS += -march=armv7-a -mthumb-interwork -mfloat-abi=hard -mfpu=neon
+#CFLAGS += -march=armv7-a -mthumb-interwork -mfloat-abi=hard -mfpu=neon
+#CXXFLAGS += --sysroot=/opt/poky/1.7/sysroots/armv7ahf-vfp-neon-poky-linux-gnueabi
+#CXXFLAGS += -isysroot /opt/poky/1.7/sysroots/armv7ahf-vfp-neon-poky-linux-gnueabi
+#CFLAGS += --sysroot=/opt/poky/1.7/sysroots/armv7ahf-vfp-neon-poky-linux-gnueabi
+#CFLAGS += -isysroot /opt/poky/1.7/sysroots/armv7ahf-vfp-neon-poky-linux-gnueabi
+##endif
+
 INSTALL 		= /usr/bin/install
 
 RELOBJS    := $(SRCS:%.cpp=$(RELEASEDIR)/%.o) 
@@ -21,11 +33,12 @@ vpath %.cpp src
 vpath %.c src
 vpath %.s src
 
-CXX = $(CROSS_COMPILE)g++
-CC  = $(CROSS_COMPILE)gcc
-AR  = $(CROSS_COMPILE)ar
-LD  = $(CROSS_COMPILE)ld
-AS  = $(CROSS_COMPILE)as
+## Allow yocto to provide these
+#CXX = $(CROSS_COMPILE)g++
+#CC  = $(CROSS_COMPILE)gcc
+#AR  = $(CROSS_COMPILE)ar
+#LD  = $(CROSS_COMPILE)ld
+#AS  = $(CROSS_COMPILE)as
 
 # All target
 all:  debug release $(TESTAPP1) $(TESTAPP2) $(TESTAPP3)
diff --git a/build_tools/make_sharedlib.rules b/build_tools/make_sharedlib.rules
index 3e8de26..33f7aca 100644
--- a/build_tools/make_sharedlib.rules
+++ b/build_tools/make_sharedlib.rules
@@ -9,8 +9,11 @@ LIBEXT		    = .so
 LIBSONAME      	= lib$(LIBNAME)$(LIBEXT)$(LIBVERMAJ)
 LIBREALNAME    	= $(LIBSONAME)$(LIBVERMIN)$(LIBVERBLD)
 
-CXXFLAGS 	   += -fPIC
-CFLAGS         += -fPIC
+## to debug compiler problems add --verbose 
+CXXFLAGS 	   += -fPIC 
+CFLAGS         += -fPIC 
+
+## to debug linker problems add -Wl,--verbose
 LNK	 		    = $(CC) -shared -Wl,-soname,$(LIBSONAME)
 
 INSTALL_DIR		= $(BUILD_ROOT)/x3c/lib
diff --git a/src/e-lib/Makefile b/src/e-lib/Makefile
index 7e58bc9..cfbef98 100644
--- a/src/e-lib/Makefile
+++ b/src/e-lib/Makefile
@@ -1,7 +1,15 @@
 BUILD_ROOT  	= ../..
 
 ## This library is always compiled for the epiphany cores
-CROSS_COMPILE=epiphany-elf-
+CROSS_COMPILE=$(EPIPHANY_CROSS_COMPILE)
+CXX = $(CROSS_COMPILE)g++
+CC  = $(CROSS_COMPILE)gcc
+AR  = $(CROSS_COMPILE)ar
+LD  = $(CROSS_COMPILE)ld
+AS  = $(CROSS_COMPILE)as
+
+CXXFLAGS    	= -Wall -Wextra -isystem$(EPIPHANY_ELF_INCLUDE)
+CFLAGS          = -Wall -Wextra -isystem$(EPIPHANY_ELF_INCLUDE)
 
 LIBNAME			= e-lib
 
diff --git a/src/e-xml/Makefile b/src/e-xml/Makefile
index f7a158b..f99d107 100644
--- a/src/e-xml/Makefile
+++ b/src/e-xml/Makefile
@@ -10,6 +10,13 @@ LIBNAME			= e-xml
 
 EXTRACXXFLAGS  	= -fmessage-length=0 -DPIC -Wno-write-strings -DLINUX -DUNIX
 
+##
+## Not sure why but this is needed
+##
+ifneq (,$(findstring arm-poky-linux-gnueabi,$(CXX)))
+EXTRACXXFLAGS  	+= -D__linux__
+endif
+
 # List of include search paths
 INCLUDES    = \
 	-I../e-hal/src				\
-- 
2.1.4

